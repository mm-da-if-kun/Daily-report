## 　2023年9月23日(土)
# 【取り組んだ課題一覧】
## ☆Docker
→[始め方 - Get started]-Part1-まで
# 【わかったこと】
『Docker-docs-ja』<br>
[始め方 - Get started]
◎Part3:アプリケーションの更新
⚫︎ソースコードの更新
・マシン上では1つのプロセス（コンテナも含みます）しか特定のポートをリッスンできないため古いコンテナが既にホスト側のポートを使用している場合は削除する必要がある。
⚫︎古いコンテナの削除
・`docker rm`コマンドに「強制force」フラグを付ければ、１回のコマンドでコンテナの停止と削除ができる。 `docker rm -f <the-container-id>`
◎Part5:データベースの保持
⚫︎コンテナのファイルシステム
コンテナの実行時、イメージの様々なレイヤーを、コンテナのファイルシステムに使う。また、各コンテナでは、ファイルを作成、更新、削除するための「スクラッチ領域」もコンテナ自身が持つ。例え同じイメージを使っていたとしても、（あるコンテナのファイルシステムに対する）あらゆる変更は、他のコンテナからは見えない。
⚫︎コンテナのボリューム
各コンテナは、イメージの定義からコンテナが起動する。コンテナはファイルの作成、更新、削除ができるが、コンテナを削除したら、それらの変更は消失する。また、コンテナに対する全ての変更とは、隔離された対象のコンテナに対してのみである。だが、ボリュームを使えば、これら全てを変えられる。
ボリュームは、コンテナ内で指定したファイルシステムのパスを、ホストマシン上へと接続できる機能を備えている。コンテナ内にディレクトリをマウントすると、ディレクトリに対する変更は、ホストマシン上からも見える。コンテナを再起動する場合にも、同じディレクトリをマウントしていれば、再起動後も同じファイルが見える。
ボリュームは主に２種類ある。
⚫︎ボリュームの作成とコンテナの起動
・`docker volume create`:ボリュームを作成する。
例）`$ docker volume create todo-db`
⚫︎ボリュームを深掘り
`docker volume inspect`コマンドを使用することでボリュームを使う時にDockerがデータを"実際に"保存する場所を調べることができる。
例）
```
$ docker volume inspect todo-db
[
    {
        "CreatedAt": "2019-09-26T02:18:36Z",
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/todo-db/_data",
        "Name": "todo-db",
        "Options": {},
        "Scope": "local"
    }
]
```
MountPointこそが、ディスク上に実際のデータを保管している場所である。ほとんどのマシンでは、このディレクトにホスト上からアクセスするにはroot権限が必要なため注意すること。
⚫︎Docker Desktop上で直接ボリュームのデータにアクセスするには
Docker Desktopを実行中に、Dockerコマンドが実際に動くのは、マシン上の小さな仮想マシン内である。マウントポイントのディレクトリ内で、実際の内容を見たい場合は、何よりもまず仮想マシン内に入る必要がある。
◎Part6:バインドマウントを使う
⚫︎バインド真人の使用
バインド マウントはホスト上のファイルシステムをコンテナ内と直接共有する。アプリケーションの動作中でも、バインドマウントを使ってソースコードをコンテナ内にマウントすると、コードの変更が見えたり反映できるようになる。つまり、アプリケーションに対する変更が、直ちに見える。

⚫︎ボリューム型の比較

|  | 名前付きボリューム | バインド マウント |
|:-----------|------------:|:------------:|
| ホスト上の場所 | Docker が選択 | 自分で決める |
| マウント例（`--mount`を使用） | `type=volume,src=my-volume,target=/usr/local/data` | `type=bind,src=/path/to/data,target=/usr/local/data` |
| コンテナの内容に新しいボリュームを加える | はい | いいえ |
| ボリューム ドライバのサポート | はい | いいえ |

⚫︎バインド マウントを試す
例）バインドマウントした ubuntu コンテナで bash を実行する
`$ docker run -it --mount type=bind,src="$(pwd)",target=/src ubuntu bash`
`--mount`オプションはDockerに対してバインドマウントの作成を命令する。
srcで示す場所は、ホストマシン上の現在の作業ディレクトリ（`getting-started/app`）である。targetで示す場所は、はコンテナ内に現れるディレクトリ（`/src`）である。
⚫︎コンテナのデプロイ
ローカル開発環境のセットアップで、バインドマウントの利用は一般的である。利点は、開発マシン上に全ての構築ツールや環境をインストールする必要がない。`docker run`コマンドを1回実行するだけで、Dockerは依存関係とツールを取得する。
⚫︎開発用のコンテナでアプリを実行
例）
```
$ docker run -dp 127.0.0.1:3000:3000 \
    -w /app --mount type=bind,src="$(pwd)",target=/app \
    node:18-alpine \
    sh -c "yarn install && yarn run dev"
```
・`-dp 127.0.0.1:3000:3000`:デタッチド（バックグラウンド）モードで実行し、ポート割り当てを作成する。
・`-w /app`:「作業ディレクトリ」 またはカレントディレクトリを指定する。
・`--mount "type=bind,src=$pwd,target=/app"`:ホスト上のカレントディレクトリを、コンテナ内の`/app`ディレクトリにバインドマウントする。
・`node:18-alpine`:使用するイメージである。なお、これが Dockerfileからアプリを作成するベースイメージである。
・`sh -c "yarn install && yarn run dev"`:シェルを開始するのに`sh`を使い（`alpine`には`bash`はない）、パッケージをインストールするため`yarn install`を実行し、開発用サーバを開始するために`yarn run dev`を実行する。packagejsonの中を見ると、devスクリプトがnodemonを起動しているのが分かる。
◎Part7:複数コンテナのアプリ
・コンテナを分けて実行する理由(下記は一部でありほかにも、いくつかの理由がある。)
①データベースとは別に、 API とフロントエンドをスケールする良い機会。
②コンテナを分けると、現在のバージョンと更新したバージョンを分離できる。
③今はローカルにあるデータベースをコンテナが使っているが、プロダクションではデータベースのマネージド サービスを利用したくなるかもしれない。
④複数のプロセスを実行するにはプロセスマネージャが必要であり（コンテナは１つのプロセスのみ起動するため）、コンテナの起動や停止が複雑になる。
⚫︎コンテナのネットワーク機能
コンテナはデフォルトでは、 孤立した状態で実行するため、同じマシン上の他のプロセスやコンテナを一切知らない。ネットワーク機能（networking）を使用することで、お互いに通信可能になる。
⚫︎MySQLの起動
コンテナをネットワークに加えるには下記の2つの方法がある。
①コンテナの起動時にネットワークを割り当てる
②既に実行しているコンテナをネットワークに接続する
下記の手順でずネットワークを作成し、MySQLコンテナの起動時に接続（アタッチ）する。
①ネットワークを作成する。
`$ docker network create todo-app`
②MySQLコンテナを起動し、先ほどのネットワークに接続する。合わせて複数の環境変数を定義する。これは、データベースの初期化に使う。
```
$ docker run -d \
     --network todo-app --network-alias mysql \
     -v todo-mysql-data:/var/lib/mysql \
     -e MYSQL_ROOT_PASSWORD=secret \
     -e MYSQL_DATABASE=todos \
     mysql:8.0
```


【次やること】
## ☆Docker
⚫︎Dockerのチュートリアルをやる( Docker-docs-ja)
→[始め方 - Get started]-Part3-まで
# 【感じたこと】
・レイヤーと似たようなもので中間イメージというものが出てきました。始めは異なる部分がよくわかりませんでしたが、読み進めているうちに異なる部分を理解することができたのでよかったです。<br>
・動画よりも踏み込んだ内容も記載されていることがあるため勉強になりました。<br>
・本日2時間0分<br>
・月合計:57時間14分<br>
・累計:460間08分<br>
